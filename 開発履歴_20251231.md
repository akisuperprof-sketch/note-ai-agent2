# Note AI Agent 2 開発プロジェクト構成・改善履歴

本ドキュメントは、2025年12月末に行われた「Note AI Agent 2」の本格的な機能強化（Reproフェーズ）における主要な意思決定と改善のプロセスを記録したものです。

---

## 開発マイルストーン

### 1. 【課題】画像生成の不安定さと透かしの除去
*   **状況**: 初期の画像生成では外部APIの「透かし（Watermark）」が入る、あるいは画像が壊れる問題が発生していた。
*   **解決**: Google Geminiの `v1beta` エンドポイントを直接叩くロジックへ移行。`gemini-3-pro-image-preview`（Nano Banana Pro）を採用。
*   **結果**: 16:9の高品質かつ透かしのない純粋な画像を安定して得られるようになった。

### 2. 【デバッグテスト 1】ナノバナナの実力確認
*   **内容**: 「量子コンピュータ × 猫」のような、抽象的かつ具体的な指示。
*   **学び**: モデルがプロンプトの細かなニュアンス（例：背景のグラデーション、ライティング）を極めて正確に再現することを確認。
*   **適用**: この成功を受け、アプリのメイン画像生成エンジンとして固定。

### 3. 【デバッグテスト 2】note記事としてのプロ級デザイン
*   **内容**: noteの見栄えに合わせたタイトルのオーバーレイ。
*   **学び**: 背景の一部をぼかす `backdrop-blur` とグラデーションの組み合わせが、最も「高級感」を生むことを発見。
*   **適用**: CSSを微調整し、アプリの「書き出し」画面をnoteの投稿プレビューのような質感に統一。

### 4. 【デバッグテスト 3】フルパッケージ生成の確立
*   **内容**: 「キャバ嬢のサンドイッチ」というテーマ。人物キャラの維持、見出し、メタデータの同時生成。
*   **学び**: ユーザーは記事本文だけでなく、「実際にそのままnoteの各項目にコピペできる素材一式」を求めていることを再認識。
*   **適用**: ブラウザ上でのタブ切替（生データ / プレビュー / スコア）を導入し、記事内画像（インライン）とメタディスクリプションの自動生成フローを追加。

### 5. 【デバッグテスト 7】「王道」デザインの確立
*   **内容**: 「AI活用の最新情報（ワークフロー）」テーマ。
*   **学び**: キャラクターに「白縁（ステッカー風）」をつけ、周囲に「コネクテッド・アイコン（関連図）」を浮かべることで、技術解説記事としての信頼性と分かりやすさが劇的に向上することを発見。
*   **適用**: 「ステッカー・スタイル」と「アイコン接続」をAI의 プロンプト構成に正式採用。また、参照画像の特徴を絶対視する「Strict Mode（必須設定）」トグルをUIに搭載。

### 6. 【最終最適化】マルチモーダル結合による一貫性の完成
*   **内容**: キャラクター必須設定（Strict Mode）の最終調整。
*   **成果**: 女子キャラのステッカー風描写とワークフローのアイコン接続が想定通りのクオリティで安定出力。

### 7. 【ブランディングと法務リスク対応】独自性の確立
*   **内容**: note.comとの混同を避けるためのUI差別化（リネーム・色彩・フォント）。
### 8. 【利便性の極大化】蓄積と連続性の確保
*   **内容**: 履歴機能と入力永続化の実装。
*   **課題**: 「一度ページを離れると設定が消える」「過去に作った最高の記事を後から見返せない」というUX上の欠点を解消。
*   **解決**: `localStorage` をフル活用し、入力フォームの自動保存と、生成済みパッケージのアーカイブ（履歴履歴）機能を搭載。また、全章の画像を後から一括生成できる「章別画像オンデマンド生成」を実装。
*   **成果**: 納得いくまで調整を繰り返す「執筆の試行錯誤」が可能になり、AIエージェントとしての実用性が格格に向上。

---

### 10. 【安定性と確実性】止まらない、消えないエージェント
*   **内容**: エラー表示UI、結果画面への本文追加、ストリーミング例外処理の実装。
*   **課題**: 通信環境の不安定なスマホでエラー時に画面が「真っ黒」になる現象、および画像生成に時間がかかり本文にアクセスできない不安感を解消。
*   **解決**: `status === "error"` 専用のUIを構築。生成結果の最初のタブに「記事原稿（テキスト）」を直接表示するように変更し、画像が未生成でも成果物を即座に確認・コピー可能にした。
*   **成果**: 万が一のエラー時もユーザーを迷わせず、たとえ通信が不安定でも「書いたもの」は必ず手元に残るという、実用ツールとしての堅牢性を確保。

---

## 技術的な重要ロジックの変遷

1.  **プロンプトエンジニアリングの二段階進化**:
    *   初期：記事からタイトルを抽出。
    *   現在：記事の内容から「比喩・メタファー」や「ワークフロー要素」をAIが予見し、デザイン的な味付け（ステッカー、ライティング）をプロンプトに動的に付与。
2.  **一貫性の維持とマルチモーダル入力**:
    *   `Strict Mode`の実装に加え、Base64画像を生成エンジン（Nano Banana Pro）に直接渡す「マルチモーダル・フィード」を確立。
3.  **動的なメタデータ・インジェクション**:
    *   生成された記事内の「見出し」をリアルタイムで解析し、それを画像生成のプロンプトや、UI上の画像オーバーレイに即座に反映させる同期ロジックを確立。
4.  **ローカルデータ・マネジメント**:
    *   複雑な「記事パッケージ（本文・画像・スコア・設定）」をステートレスなブラウザ環境で安全に保存・復元するためのシリアライズ・デシリアライズ処理を確立。
5.  **再帰的品質保証プロセス**:
    *   生成物の「長さ」をクライアントサイドで評価し、不足している場合にバックエンドへ「どこを強化すべきか」のフィードバックと共に再リクエストを送る「自己修正ループ」を確立。
6.  **フォールバック型アウトプット・デリバリー**:
    *   成果物を「画像」と「テキスト」に分離して管理し、リソースの重い画像生成の成否に関わらず、軽量なテキストを最優先でユーザーに引き渡す非同期的な信頼性維持メカニズム。

---

### 11. 【クリエイティブの最終調整】ユーザー主権と品質の調和
*   **内容**: アイキャッチタイトルのトグル実装、インライン画像の高品質化、部分リトライ機能。
*   **課題**: 「タイトルは画像の上に置きたくない」「記事内画像のクオリティが低い」「通信エラーで画像1枚だけ失敗した時に全部やり直すのが苦痛」というフィードバックに対応。
*   **解決**: 
    1.  **タイトル・スイッチ**: アイキャッチ内にタイトルを入れるかどうかをユーザーが選択可能にした（OFF時は画像下部に表示）。
    2.  **インライン画像・プロンプト強化**: 記事内画像もアイキャッチと同じ画風ロジックを適用し、高品質なイラストとして出力。
    3.  **ピンポイント・リカバリー**: アイキャッチや特定の記事内画像だけが失敗した場合、その画像だけを「再試行」できるボタンを実装。
    4.  **メタディスクリプションUI刷新**: 本物のnoteに近い、コピーしやすい専用UIへアップデート。
    5.  **ハッシュタグ自動提案**: 記事に最適なタグをAIが生成。投稿時に迷わないよう「一括コピー」機能を搭載。
*   **成果**: AIによる全自動プロデュースの「手軽さ」を維持しつつ、プロが求める「微調整」と「投稿準備の自動化」を両立。

---

**記録日**: 2025-12-31
**ステータス**: フェーズ7（One-click Publishing Readiness）完了。最終安定版 v3.6。

---

### 12. 【note投稿の壁の突破】自動・半自動ハイブリッド戦略
*   **内容**: note.comの強力なボット対策による「Tags: 28（骨組み表示）」問題の解消。
*   **課題**: 自動ブラウザ（Playwright）からのアクセス時、JavaScriptの実行が遮断され、エディタが読み込まれないフリーズ現象が発生。
*   **解決案の変遷**:
    1.  **モバイル偽装**: iPhone Safariとして振る舞い、検知網を回避。
    2.  **スーパーステルス**: ブラウザの深層（navigator, plugins等）を徹底的に人間らしく偽装。
    3.  **ストレージ・フル同期**: クッキーだけでなく `localStorage` も同期し、既存ユーザーとして接近。
    4.  **沈黙への刺激**: 骨組み状態で固まった際、グリッド状に画面をタップ（クリック）してJSの起動（ハイドレーション）を促す。
*   **到達点**: 数々のステルス強化によりフルオートの生存率を高めつつ、同時に「半自動モード」という逃げ道を確立。

### 13. 【UXの最終洗練】「魔法のコード」と爆速デバッグ
*   **内容**: ブックマークレット方式の導入とログ表示の直感化。
*   **課題**: 成功率100%を求める場合、ボット検知のないユーザー自身のブラウザが最強だが、コンソールを開くのが面倒。また、デバッグ時のログが古いものから順に並んでおり、最新状況が見にくい。
*   **解決**:
    1.  **1クリック・ブックマークレット**: 保存したブックマークを押すだけで、全内容がエディタへ吸い込まれる「魔法のコード」を自動生成。コンソール不要の体験を実現。
    2.  **リバース・リアルタイムログ**: 常に「最新のログが一番上」に来るように表示順を反転。また、新しい試行のたびに古いログを物理的に一掃するように刷新。
    3.  **デバッグ即時開始**: 開発モードでの検証時、警告ポップアップを排除して即座に実行に移れるようにショートカット化。
*   **成果**: フルオートでの挑戦（ロマン）と、半自動での確実な成功（実益）を両立。パンダのアシスタントとしての利便性が次元を超えて向上した。

---

### 14. 【心理的導線の完成】黄金の読了構成とスマート・フィルタリング
*   **内容**: 「序章 → 目次 → 本編」構成の自動化と、内部用メタ情報の分離。
*   **課題**: 20,000文字超の長文を確実に生成するための「内部構成案（計画書）」がそのまま記事に残ってしまう問題、および読者が離脱しやすい冒頭の改善。
*   **解決**: 
    1.  **ゴールデン・ルート**: 「心を掴む序章（プロローグ）」→「全体像を示す目次」→「詳細な本編」の順で執筆するようプロンプトを刷新。
    2.  **サイレント・プランニング**: AIへの指示に「セパレーター（境界線）」を導入。システム側で「計画書」部分を自動検知してカットすることで、ユーザーには「完成した原稿」だけが渡るように最適化した。
    3.  **目次の自動生成**: プレースホルダーではなく、実際に読者の利便性を高める番号付きの目次セクションを記事内に組み込むロジックを確立。

### 15. 【モバイルファーストの頂点】焼き込み自動化とクイックコピー
*   **内容**: アイキャッチへのタイトル自動合成と、スマホ専用コピーUIの実装。
*   **課題**: スマホでの長文選択・コピーの困難さと、タイトル入りのアイキャッチを作るための「保存→加工」という手順の煩雑さ。
*   **解決**:
    1.  **Canvas自動焼き込み**: 画像生成直後にブラウザ裏側でCanvas合成を自動実行。「保存」を押すだけで、最初からタイトルが入った「完成形」の画像ファイルが得られるようにアップデート。
    2.  **Mobile Copy Helper**: スマホ用に「浮かぶクイックボタン」を実装。タイトル・本文・タグを順次1タップでコピーできる専用UIにより、投稿準備が数十秒で完了する体験を実現。
    3.  **堅牢なJSON解析**: AI提案時に稀に発生する `[object Object]` 表示（解析ミス）を徹底排除。あらゆるデータ形式を人間が読みやすいテキストへ自動成型するロジックを全方位に適用。

---

### 16. 【暗黒のデバッグ戦：リグレッションとその克服】
*   **内容**: note.comへの「完全自動投稿（MODE 4）」における不安定性と、デバッグ過程で発生した「後退（デグレード）」の解決。
*   **課題**: 
    1.  **Vercel環境の壁**: Vercel等のサーバー環境ではファイル書き込みが制限されており、セッションやジョブの保存（.gemini/）でエラーが発生し、処理がS01（初期化）で止まる。
    2.  **ステルス偽装の副作用**: より人間に見せようと追加したカスタムヘッダー（Origin, Referer等）が、逆にnote側のCORSポリシーやセキュリティに抵触し、通信が遮断される。
    3.  **通信プロトコルのズレ**: サーバーから送る進捗ログに `data: ` という古いラベルを付けていたため、フロントエンドの `JSON.parse` がエラーを起こし、UIがフリーズしたように見える。
*   **解決**:
    1.  ** `/tmp` パスへの完全移行**: サーバー環境での書き込み権限エラーを回避するため、保存先を `/tmp` に動的に切り替えるロジックを確立。
    2.  **「実績ベース」のヘッダー回帰**: 成功実績のある最小限のヘッダー構成に戻し、Playwright本来の自然な挙動に任せることで通信の壁を突破。
    3.  **JSON-Lineストリームの厳格化**: 余計な接頭辞を排除し、純粋なJSON行を1行ずつ送ることで、フロントエンドとのリアルタイム同期を完全修正。
*   **成果**: 複雑化しすぎたコードを「成功していた時のシンプルさ」に差し戻し、環境依存のエラーをすべて排除。S05（チュートリアル突破）まで確実に到達できる「安定した再起動地点」を再構築した。

---

### 17. 【Rabbit Modeの実装】非公式APIによる高速化
*   **内容**: note自動投稿の第三の選択肢として、ブラウザ操作を行わない「Rabbit Mode（うさぎモード）」を実装。
*   **課題**: 
    1.  **Browserlessの限界**: note.comのボット検知が厳しく、ヘッドレスブラウザからの操作が頻繁にブロックまたはタイムアウトする。
    2.  **API仕様の複雑さ**: `XSRF-TOKEN` の欠如による `422 Unprocessable Content` エラーや、独自のリクエストヘッダー要件。
*   **解決**:
    1.  **APIルートの分離**: `/api/dev/note-draft-rabbit` を新設し、依存関係のないピュアな `fetch` クライアントを構築。
    2.  **セッション・パーサー**: 保存された `note-session.json` から `XSRF-TOKEN` を精密に抽出し、カスタムヘッダー `X-XSRF-TOKEN` として注入するロジックを実装。
    3.  **UI統合**: 通常のデバッグモードとは別に、専用の「Rabbit」モードをヘッダーに配置。誤爆防止の保護機能（Confirm + PreventDefault）も整備。
*   **成果**: 不安定で数分かかっていた投稿プロセスが、わずか数秒で完遂する圧倒的なスピードと安定性を獲得。

---

### 18. 【Rabbit Mode修正】下書き本文消失問題の解決
*   **事象**: Rabbit Modeでの投稿時、API呼び出しは成功（200 OK）しタイトルは保存されるものの、**本文が空の状態で下書き保存される**現象が発生。
*   **原因**: 
    1.  当初使用していた公開APIエンドポイント (`POST /api/v1/text_notes` および `PUT /api/v1/text_notes/{key}`) が、特定の形式の本文（HTML構造など）を受け付けない、または内部的に無視していた可能性。
    2.  ブラウザのネットワーク解析（Sniffing）により、公式Webエディタが下書き保存時に全く別のエンドポイントを使用していることが判明。
*   **解決**:
    1.  **エンドポイントの変更**: 本文保存のプロセスを、Webエディタが使用する内部API `POST /api/v1/text_notes/draft_save` に切り替え。
    2.  **IDベースの更新**: `draft_save` には記事の `key` ではなく数値の `id` が必要であるため、新規作成時のレスポンスから `id` を抽出して引き継ぐロジックを実装。
    3.  **ペイロードの適正化**: 公式エディタの挙動に合わせ、フラットなJSON構造 (`body`, `body_length`, `name`, `index`, `is_lead_form`) を採用。
*   **成果**: これにより、Rabbit Modeにおいても本文（HTML形式）が正しく反映された状態で下書き保存されることを確認。

---

**最終記録日**: 2026-01-04
**最新ステータス**: v6.1 (Rabbit Mode Stability Fix - Draft Content)
